Причуды Float в Руби
====================

| Проект:        | [Энту́ру](https://www.github.com/kyrylo/entooru/)
|:---------------|:-----------------------------------------------------------------
| Автор:         | Клеменс Хельм <clemens@rails-troubles.com>
| Дата:          | 10 января 2012 года
| URI:           | [http://www.rails-troubles.com/2011/12/ruby-float-quirks.html][0]
| Перевел:       | Кирилл Силин <kyrylosilin@gmail.com>
| Дата перевода: | 13 января 2012 года


Работа с числами с плавающей точкой иногда действительно приводит к неожиданному
поведению. Рассмотрим следующий пример:

``` ruby
def greater_than_sum?(float1, float2)
  difference = float1 - float2
  difference + float2 > float1
end
```
Вы могли бы ожидать от этого метода постоянное возвращение `false`. Однако
попытайтесь вызвать `greater_than_sum?(214.04, 74.79)` и он вернет `true`!

Проблема
--------

Запустите _irb_ и введите `139.25 + 74.79`, тогда вы увидите причину этого
поведения: результатом будет `214.04000000000002`, что, очевидно, немножечко
больше, чем `214.04`.

Числа с плавающей точкой не могут записывать в память десятичные дроби точно.
Причина таится в том, что _Float_ всегда преобразовывает числа из двоичной
системы счисления в десятичную и наоборот.

Вероятно, вы знаете, не все числа могут быть представлены, как десятичные. Когда
вы делите `1/3`, результатом будет `0.33333333333333…`. Бесконечная цепочка из
троек.

Это же правило справедливо и для двоичных чисел. Когда десятичное число
преобразовано в двоичное, то результирующее двоичное число может быть
бесконечным. Но, поскольку память наших компьютеров не бесконечна, чтобы
представлять такое число, компьютер отсекает число в каком-то месте. Это
приводит к ошибке округления — как раз то, с чем мы имеем здесь дело.

Решение
-------

К нашему предыдущему примеру вы можете добавить условие, чтобы проверить, лежит
ли число в некотором интервале другого числа, называемого _delta_:

``` ruby
def greater_than_sum?(float1, float2)
  delta = 0.0001
  difference = float1 - float2
  difference + float2 > float1 && difference + float2 - float1 < delta
end
```

Какое число вы выберете для _delta_ в значительной степени зависит от вас. Оно
зависит от требуемой вам точности в ваших сравнениях, но с одной оговоркой: к
сожалению, чем больше выполняется вычислений с числом, тем больше растет
погрешность расчета.

Решение для чисел с десятичной дробью
-------------------------------------

Если вам нужно точно сравнить 2 числа с десятичной дробью, то наверное, будет
лучше использовать [BigDecimal][1] (англ.). Все вычисления с числами с десятичной
дробью в _BigDecimal_ гораздо точнее, чем _Float_.

Так что отныне я просто использую _BigDecimal_ вместо _Float_!

Конечно, вы можете делать так, но есть один большой недостаток: вычисления с
числами _BigDecimal_ в значительной степени медленнее. Логика работы чисел с
плавающей точкой, которую использует _Float_, реализована непосредственно в
аппаратном обеспечении процессора вашего компьютера. Благодаря этому, вычисления
невероятно быстрые. Числа _BigDecimal_, с другой стороны, — это всего лишь
программная реализация, призванная справиться с недостатками _Float_ без прямой
поддержки аппаратного обеспечения. Более подробно в [Википедии][2] (англ.).

Так вот, всякий раз когда это возможно, используйте числа _Float_ — именно поэтому
они стандартные. Когда вам необходимы числа с точной десятичной дробью
(например, вы работаете с валютой), используйте _BigDecimal_.

Если вы желаете немножко углубиться в тему, почитайте «[Что Должен Знать Каждый
Компьютерный Специалист об Арифметике с Плавающей Точкой][3]» (англ.).

Приятного чтения ;)

[0]: http://www.rails-troubles.com/2011/12/ruby-float-quirks.html
[1]: http://www.ruby-doc.org/stdlib-1.9.3/libdoc/bigdecimal/rdoc/BigDecimal.html
[2]: http://en.wikipedia.org/wiki/Arbitrary-precision_arithmetic#Implementation_issues
[3]: http://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html
